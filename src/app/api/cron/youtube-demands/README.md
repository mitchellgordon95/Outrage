# YouTube Demands Cron Job

This cron job fetches recent videos from specified YouTube channels, analyzes their content using Apify for reliable transcript extraction, and generates political demands based on the video content.

## Configuration

### Environment Variables

Add these to your `.env` file:

```env
# Apify API token for YouTube Scraper actor
APIFY_TOKEN=your_apify_token

# Comma-separated list of YouTube channel URLs to monitor
# Format: https://www.youtube.com/channel/UC_CHANNEL_ID
YOUTUBE_CHANNELS=https://www.youtube.com/channel/UC_CHANNEL_ID_1,https://www.youtube.com/channel/UC_CHANNEL_ID_2

# Cron job authentication secret (auto-generated by Vercel)
CRON_SECRET=your_cron_secret
```

### Finding YouTube Channel URLs

1. Go to the YouTube channel page
2. Copy the channel URL from your browser
3. The URL should be in format: `https://www.youtube.com/channel/UCxxxxxxxx`
4. Example: `https://www.youtube.com/channel/UCuVgoagmU3hmfMwtxG9s4Sw`

## How It Works

1. **Fetch Videos**: Uses Apify's YouTube Scraper to get the 10 most recent videos with transcripts from each configured channel
2. **Get Transcripts**: Apify automatically downloads subtitles/captions in SRT format (prefers English, auto-generated if needed)
3. **Analyze Content**: Uses AI to analyze video content and generate political demands
4. **Store Results**: Saves demands to the `youtube_demands` table with source metadata

## Schedule

The cron job runs every 6 hours (`0 */6 * * *` in cron syntax).

## Why Apify?

We switched from the `youtube-transcript` npm package to Apify because:
- **More Reliable**: Better success rate for transcript extraction
- **Batch Processing**: Can fetch multiple videos from a channel in one call
- **Multiple Formats**: Supports various subtitle formats (SRT, VTT, etc.)
- **Language Support**: Can specify preferred subtitle language
- **Auto-generated Support**: Can fetch auto-generated subtitles when manual ones aren't available
- **Better Error Handling**: More informative error messages and retry logic

## Rate Limiting

- Apify has its own rate limits based on your subscription
- The cron job includes 1-second delays between video processing for API courtesy

## Database Schema

Run the SQL in `youtube_demands_schema.sql` to create the required table.

## Testing

You can manually trigger the cron job:

```bash
# Local testing
curl -X POST http://localhost:3000/api/cron/youtube-demands

# Production (requires authentication)
curl -X POST https://your-domain.com/api/cron/youtube-demands \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

## Apify Actor Details

We use the [YouTube Scraper](https://apify.com/streamers/youtube-scraper) actor which provides:

- Video metadata (title, description, views, likes, etc.)
- Channel information
- Subtitles/captions in multiple formats
- Filtering options (exclude shorts, streams, etc.)
- Sorting options (newest, popular, oldest)

### Actor Input Configuration

The cron job uses these settings:
- `downloadSubtitles`: true
- `subtitlesLanguage`: 'en' (English)
- `preferAutoGeneratedSubtitles`: true
- `maxResults`: 10 (videos per channel)
- `maxResultsShorts`: 0 (exclude shorts)
- `maxResultStreams`: 0 (exclude streams)
- `sortVideosBy`: 'NEWEST'

## Monitoring

Check the Vercel Functions logs for cron job execution details:

```bash
vercel logs --filter youtube-demands
```

## Security

- The cron endpoint is protected by Vercel's cron authentication
- In production, only Vercel can call this endpoint
- Never expose your YouTube API key in client-side code